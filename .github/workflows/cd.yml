name: Release from tag
on:
  workflow_dispatch:
  push:
    tags:
      - "*.*.*"
env:
  CARGO_TERM_COLOR: always

jobs:
  build_ui:
    name: Build UI
    runs-on: rsplayer-self-hosted
    steps:
    - uses: actions/checkout@v4
    - name: Build release
      run: cargo make build_ui_release
    - name: Upload pkg dir
      uses: actions/upload-artifact@v4
      with:
        name: web_ui
        path: rsplayer_web_ui/public/pkg

  build_backend:
    needs: build_ui
    name: Release Backend
    runs-on: rsplayer-self-hosted
    strategy:
      # Fix flakiness: Run jobs sequentially to avoid race conditions on shared workspace files
      max-parallel: 1
      fail-fast: false
      matrix:
        target: ["arm-unknown-linux-gnueabihf", "armv7-unknown-linux-gnueabihf", "aarch64-unknown-linux-gnu", "x86_64-unknown-linux-gnu"]
    steps:
    - uses: actions/checkout@v4
      with:
        clean: true
    
    # Ensure no stale binary exists from a previous run or sibling job
    - name: Clean Shared Target
      run: rm -rf target/release || true

    - name: Download web_ui
      uses: actions/download-artifact@v4
      with:
        name: web_ui
        path: rsplayer_web_ui/public/pkg

    - name: Build and Package
      env:
        TARGET: ${{ matrix.target }}
        RELEASE_VERSION: ${{ github.ref_name }}
      run: |
        cargo make --env TARGET=$TARGET build_release
        cargo make --env RELEASE_VERSION=$RELEASE_VERSION --env TARGET=$TARGET package_deb_release

    - name: Upload deb package
      uses: actions/upload-artifact@v4
      with:
        name: deb-${{ matrix.target }}
        path: target/${{ matrix.target }}/debian/*.deb
        if-no-files-found: error

    - name: Upload binary
      uses: actions/upload-artifact@v4
      with:
        name: rsplayer-${{ matrix.target }}
        path: target/${{ matrix.target }}/release/rsplayer
        if-no-files-found: error

  publish:
    needs: build_backend
    name: Create release
    runs-on: rsplayer-self-hosted
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Prepare Release Assets
      run: |
        mkdir -p release_assets
        
        # Move binaries (Robust checks for missing targets)
        [ -d "rsplayer-aarch64-unknown-linux-gnu" ] && mv rsplayer-aarch64-unknown-linux-gnu/rsplayer release_assets/rsplayer_arm64 || true
        [ -d "rsplayer-armv7-unknown-linux-gnueabihf" ] && mv rsplayer-armv7-unknown-linux-gnueabihf/rsplayer release_assets/rsplayer_armhfv7 || true
        [ -d "rsplayer-arm-unknown-linux-gnueabihf" ] && mv rsplayer-arm-unknown-linux-gnueabihf/rsplayer release_assets/rsplayer_armhfv6 || true
        [ -d "rsplayer-x86_64-unknown-linux-gnu" ] && mv rsplayer-x86_64-unknown-linux-gnu/rsplayer release_assets/rsplayer_amd64 || true

        # Move debs
        [ -d "deb-arm-unknown-linux-gnueabihf" ] && find deb-arm-unknown-linux-gnueabihf -name "*.deb" -exec mv {} release_assets/rsplayer_${{ github.ref_name }}_armhfv6.deb \; || true
        [ -d "deb-armv7-unknown-linux-gnueabihf" ] && find deb-armv7-unknown-linux-gnueabihf -name "*.deb" -exec mv {} release_assets/rsplayer_${{ github.ref_name }}_armhfv7.deb \; || true
        [ -d "deb-aarch64-unknown-linux-gnu" ] && find deb-aarch64-unknown-linux-gnu -name "*.deb" -exec mv {} release_assets/rsplayer_${{ github.ref_name }}_arm64.deb \; || true
        [ -d "deb-x86_64-unknown-linux-gnu" ] && find deb-x86_64-unknown-linux-gnu -name "*.deb" -exec mv {} release_assets/rsplayer_${{ github.ref_name }}_amd64.deb \; || true

        ls -R release_assets

    - name: Create Release
      uses: ncipollo/release-action@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        artifacts: "release_assets/*"
        draft: true
        prerelease: true
        generateReleaseNotes: true
        allowUpdates: true
        token: ${{ secrets.GITHUB_TOKEN }}
